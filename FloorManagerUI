using UnityEngine;
using System.Collections;

/// <summary>
/// Displays floor number, wave number, enemies remaining, and wave start notifications
/// </summary>
public class FloorManagerUI : MonoBehaviour
{
    [Header("UI Text References")]
    [Tooltip("Text showing current floor (e.g., 'Floor 5')")]
    public TMPro.TextMeshProUGUI floorText;

    [Tooltip("Text showing current wave (e.g., 'Wave 2/3')")]
    public TMPro.TextMeshProUGUI waveText;

    [Tooltip("Text showing enemies remaining (e.g., 'Enemies: 12')")]
    public TMPro.TextMeshProUGUI enemiesRemainingText;

    [Tooltip("Text shown when wave starts (e.g., 'Wave 1 Start!')")]
    public TMPro.TextMeshProUGUI waveStartText;

    [Header("Wave Start Settings")]
    [Tooltip("How long to show wave start text (in seconds)")]
    [Range(1f, 5f)]
    public float waveStartDisplayDuration = 2f;

    [Header("Debug")]
    public bool showDebugInfo = false;

    // Private variables
    private int currentFloor = 1;
    private int currentWave = 1;
    private int totalWaves = 1;
    private int enemiesRemaining = 0;
    private float waveStartTimer = 0f;

    void Start()
    {
        // Hide wave start text initially
        if (waveStartText != null)
        {
            waveStartText.gameObject.SetActive(false);
        }

        // Hide UI initially (player is in lobby)
        HideUI();

        // Initialize display (even though hidden)
        UpdateFloorDisplay();
        UpdateWaveDisplay();
        UpdateEnemiesDisplay();

        if (showDebugInfo)
        {
            Debug.Log("FloorManagerUI initialized! UI hidden (waiting in lobby)");
        }
    }

    void Update()
    {
        // Handle wave start text timer
        if (waveStartTimer > 0f)
        {
            waveStartTimer -= Time.deltaTime;

            if (waveStartTimer <= 0f && waveStartText != null)
            {
                waveStartText.gameObject.SetActive(false);
            }
        }
    }

    /// <summary>
    /// Set the current floor number
    /// </summary>
    public void SetFloor(int floorNumber)
    {
        currentFloor = floorNumber;
        UpdateFloorDisplay();

        if (showDebugInfo)
        {
            Debug.Log($"Floor set to: {floorNumber}");
        }
    }

    /// <summary>
    /// Set the current wave and total waves for this floor
    /// </summary>
    public void SetWave(int waveNumber, int totalWavesForFloor)
    {
        currentWave = waveNumber;
        totalWaves = totalWavesForFloor;
        UpdateWaveDisplay();

        if (showDebugInfo)
        {
            Debug.Log($"Wave set to: {waveNumber}/{totalWavesForFloor}");
        }
    }

    /// <summary>
    /// Update the enemies remaining count
    /// </summary>
    public void SetEnemiesRemaining(int count)
    {
        enemiesRemaining = count;
        UpdateEnemiesDisplay();
    }

    /// <summary>
    /// Show wave start text (doesn't change the text, just shows it with fade)
    /// </summary>
    public void ShowWaveStart()
    {
        if (waveStartText != null)
        {
            // Don't change the text - just show it
            waveStartText.gameObject.SetActive(true);
            waveStartTimer = waveStartDisplayDuration;

            // Start fade animation
            StartCoroutine(FadeWaveStartText());

            if (showDebugInfo)
            {
                Debug.Log("Showing wave start text with fade animation");
            }
        }
    }

    /// <summary>
    /// Fade in and fade out animation for wave start text
    /// </summary>
    IEnumerator FadeWaveStartText()
    {
        if (waveStartText == null) yield break;

        float fadeDuration = 0.5f; // Time to fade in/out
        float displayTime = waveStartDisplayDuration - (fadeDuration * 2); // Time at full opacity

        // Fade IN
        float elapsed = 0f;
        while (elapsed < fadeDuration)
        {
            elapsed += Time.unscaledDeltaTime; // Use unscaled in case game is paused
            float alpha = Mathf.Clamp01(elapsed / fadeDuration);
            SetTextAlpha(waveStartText, alpha);
            yield return null;
        }
        SetTextAlpha(waveStartText, 1f); // Ensure fully visible

        // STAY visible
        yield return new WaitForSecondsRealtime(displayTime);

        // Fade OUT
        elapsed = 0f;
        while (elapsed < fadeDuration)
        {
            elapsed += Time.unscaledDeltaTime;
            float alpha = Mathf.Clamp01(1f - (elapsed / fadeDuration));
            SetTextAlpha(waveStartText, alpha);
            yield return null;
        }
        SetTextAlpha(waveStartText, 0f); // Ensure fully transparent

        // Hide the object
        waveStartText.gameObject.SetActive(false);
    }

    /// <summary>
    /// Helper to set text alpha (transparency)
    /// </summary>
    void SetTextAlpha(TMPro.TextMeshProUGUI text, float alpha)
    {
        if (text != null)
        {
            Color color = text.color;
            color.a = alpha;
            text.color = color;
        }
    }

    /// <summary>
    /// Show wave start text with custom text (for special waves)
    /// </summary>
    public void ShowWaveStart(string customText)
    {
        if (waveStartText != null)
        {
            waveStartText.text = customText;
            ShowWaveStart();
        }
    }

    /// <summary>
    /// Hide wave start text immediately
    /// </summary>
    public void HideWaveStart()
    {
        if (waveStartText != null)
        {
            waveStartText.gameObject.SetActive(false);
            waveStartTimer = 0f;
        }
    }

    // Update display methods
    void UpdateFloorDisplay()
    {
        if (floorText != null)
        {
            floorText.text = $"Floor {currentFloor}";
        }
    }

    void UpdateWaveDisplay()
    {
        if (waveText != null)
        {
            if (totalWaves > 1)
            {
                waveText.text = $"Wave {currentWave}/{totalWaves}";
            }
            else
            {
                waveText.text = $"Wave {currentWave}";
            }
        }
    }

    void UpdateEnemiesDisplay()
    {
        if (enemiesRemainingText != null)
        {
            enemiesRemainingText.text = $"Enemies: {enemiesRemaining}";
        }
    }

    // Public getters
    public int GetCurrentFloor() => currentFloor;
    public int GetCurrentWave() => currentWave;
    public int GetEnemiesRemaining() => enemiesRemaining;

    /// <summary>
    /// Hide all UI elements (for lobby)
    /// </summary>
    public void HideUI()
    {
        if (floorText != null) floorText.gameObject.SetActive(false);
        if (waveText != null) waveText.gameObject.SetActive(false);
        if (enemiesRemainingText != null) enemiesRemainingText.gameObject.SetActive(false);

        if (showDebugInfo)
        {
            Debug.Log("FloorManagerUI: UI hidden");
        }
    }

    /// <summary>
    /// Show all UI elements (when game starts)
    /// </summary>
    public void ShowUI()
    {
        if (floorText != null) floorText.gameObject.SetActive(true);
        if (waveText != null) waveText.gameObject.SetActive(true);
        if (enemiesRemainingText != null) enemiesRemainingText.gameObject.SetActive(true);

        if (showDebugInfo)
        {
            Debug.Log("FloorManagerUI: UI shown");
        }
    }
}
