using UnityEngine;
using UnityEngine.UI;
using System.Collections;
using System.Collections.Generic;

public class UpgradeManager : MonoBehaviour
{
    [Header("Player References")]
    [Tooltip("The player GameObject")]
    public GameObject player;

    [Tooltip("Camera control script - drag ModernFPSCamera here")]
    public ModernFPSCamera cameraControlScript;

    [Tooltip("Pause manager (to disable pausing in upgrade room)")]
    public PauseManager pauseManager;

    [Header("UI References")]
    [Tooltip("The 3 upgrade choice buttons")]
    public Button upgradeButton1;
    public Button upgradeButton2;
    public Button upgradeButton3;

    [Tooltip("Continue button (already has onClick set up)")]
    public GameObject continueButton;

    [Tooltip("Text labels for upgrade names (TextMeshPro) - Optional but recommended")]
    public TMPro.TextMeshProUGUI upgradeText1;
    public TMPro.TextMeshProUGUI upgradeText2;
    public TMPro.TextMeshProUGUI upgradeText3;

    [Header("Upgrade Button Images")]
    [Tooltip("Sprite images for each upgrade type (assign in Inspector)")]
    public Sprite moveSpeedSprite;
    public Sprite maxSpeedSprite;
    public Sprite accelerationSprite;
    public Sprite slideBoostSprite;
    public Sprite groundDragSprite;
    public Sprite airDragSprite;
    public Sprite jumpForceSprite;
    public Sprite fireRateSprite;

    [Header("Upgrade Values - SETS to fixed values (not additive)")]
    [Tooltip("Move speed tiers - each upgrade picks next tier")]
    public float[] moveSpeedTiers = { 35f, 40f, 45f, 50f, 55f };

    [Tooltip("Max speed tiers")]
    public float[] maxSpeedTiers = { 25f, 30f, 35f, 40f, 45f };

    [Tooltip("Acceleration tiers")]
    public float[] accelerationTiers = { 15f, 20f, 25f, 30f, 35f };

    [Tooltip("Slide boost tiers")]
    public float[] slideBoostTiers = { 10f, 15f, 20f, 25f, 30f };

    [Tooltip("Ground drag tiers (lower = less drag, faster movement)")]
    public float[] groundDragTiers = { 4f, 3f, 2f, 1f, 0.5f };

    [Tooltip("Air drag tiers (lower = less drag, better air control)")]
    public float[] airDragTiers = { 1.5f, 1f, 0.5f, 0.2f, 0.1f };

    [Tooltip("Jump force tiers")]
    public float[] jumpForceTiers = { 8f, 10f, 12f, 14f, 16f };

    [Tooltip("Fire rate tiers (LOWER = FASTER: 0.05=fast, 0.01=very fast, 0.001=ultra fast)")]
    public float[] fireRateTiers = { 0.05f, 0.01f, 0.001f };

    [Header("Particle Effect (Optional)")]
    [Tooltip("Particle effect to play when upgrade is selected")]
    public GameObject upgradeParticleEffect;

    [Header("Debug")]
    public bool showDebugInfo = true;
    [Tooltip("Show detailed sprite/button assignment logs (creates spam)")]
    public bool showDetailedLogs = false;

    // Private variables
    private List<UpgradeType> availableUpgrades = new List<UpgradeType>();
    private UpgradeType selectedUpgrade1;
    private UpgradeType selectedUpgrade2;
    private UpgradeType selectedUpgrade3;

    // Track how many times each upgrade has been picked
    private int moveSpeedLevel = 0;
    private int maxSpeedLevel = 0;
    private int accelerationLevel = 0;
    private int slideBoostLevel = 0;
    private int groundDragLevel = 0;
    private int airDragLevel = 0;
    private int jumpForceLevel = 0;
    private int fireRateLevel = 0;
    private bool hasSelectedUpgrade = false;
    private bool isPrewarming = false; // Track if we're prewarming

    // Components to disable
    private MomentumMovement movementScript;
    private PlayerShooting shootingScript;

    // Enum for upgrade types
    public enum UpgradeType
    {
        MoveSpeed,
        MaxSpeed,
        Acceleration,
        SlideBoost,
        GroundDrag,
        AirDrag,
        JumpForce,
        FireRate
    }

    void Awake()
    {
        // Initialize upgrade pool EARLY (before Start, before OnEnable)
        InitializeUpgradePool();
    }

    void Start()
    {
        // Validate references
        if (player == null)
        {
            Debug.LogError("UpgradeManager: Player not assigned!");
            enabled = false;
            return;
        }

        // Get player components
        movementScript = player.GetComponent<MomentumMovement>();
        shootingScript = player.GetComponent<PlayerShooting>();

        if (movementScript == null || shootingScript == null)
        {
            Debug.LogError("UpgradeManager: Missing movement or shooting script on player!");
            enabled = false;
            return;
        }

        // Set up button listeners (clear first to prevent duplicates)
        if (upgradeButton1 != null)
        {
            upgradeButton1.onClick.RemoveAllListeners();
            upgradeButton1.onClick.AddListener(() => SelectUpgrade(1));
        }

        if (upgradeButton2 != null)
        {
            upgradeButton2.onClick.RemoveAllListeners();
            upgradeButton2.onClick.AddListener(() => SelectUpgrade(2));
        }

        if (upgradeButton3 != null)
        {
            upgradeButton3.onClick.RemoveAllListeners();
            upgradeButton3.onClick.AddListener(() => SelectUpgrade(3));
        }

        // Hide continue button initially
        if (continueButton != null)
        {
            continueButton.SetActive(false);
        }

        // PREWARM: Activate and deactivate the upgrade room to force initialization
        // Use coroutine with delay to avoid allocation warnings
        StartCoroutine(PrewarmAfterDelay());

        if (showDebugInfo)
        {
            Debug.Log("UpgradeManager initialized!");
        }
    }

    IEnumerator PrewarmAfterDelay()
    {
        // Wait a frame to let Unity finish initialization
        yield return new WaitForEndOfFrame();

        PrewarmUpgradeRoom();

        if (showDebugInfo)
        {
            Debug.Log("Prewarm completed!");
        }
    }

    /// <summary>
    /// Prewarm the upgrade room by activating it once, then immediately deactivating
    /// This ensures everything is initialized before the player actually sees it
    /// </summary>
    void PrewarmUpgradeRoom()
    {
        if (showDebugInfo)
        {
            Debug.Log("Prewarming upgrade room...");
        }

        // Check if the upgrade room GameObject exists
        GameObject upgradeRoomObject = gameObject;

        // Store original active state
        bool wasActive = upgradeRoomObject.activeSelf;

        // Set prewarm flag BEFORE activating
        isPrewarming = true;

        // Activate if not already active (this triggers OnEnable, but it will skip full prep)
        if (!wasActive)
        {
            upgradeRoomObject.SetActive(true);
        }
        else
        {
            // If already active, manually call randomize
            RandomizeUpgrades();
        }

        // Clear prewarm flag
        isPrewarming = false;

        // Deactivate if it wasn't originally active
        if (!wasActive)
        {
            upgradeRoomObject.SetActive(false);
        }

        if (showDebugInfo)
        {
            Debug.Log("Upgrade room prewarmed successfully!");
        }
    }

    void OnEnable()
    {
        // Make sure pool is initialized (safety check)
        if (availableUpgrades.Count == 0)
        {
            InitializeUpgradePool();
        }

        // Re-add button listeners (they might have been removed)
        SetupButtonListeners();

        // If this is prewarm, only randomize upgrades (skip disabling controls, cursor unlock, etc.)
        if (isPrewarming)
        {
            RandomizeUpgrades();
            return;
        }

        // Called when upgrade room is activated (for real)
        PrepareUpgradeRoom();
    }

    void SetupButtonListeners()
    {
        if (upgradeButton1 != null)
        {
            upgradeButton1.onClick.RemoveAllListeners();
            upgradeButton1.onClick.AddListener(() => SelectUpgrade(1));
        }

        if (upgradeButton2 != null)
        {
            upgradeButton2.onClick.RemoveAllListeners();
            upgradeButton2.onClick.AddListener(() => SelectUpgrade(2));
        }

        if (upgradeButton3 != null)
        {
            upgradeButton3.onClick.RemoveAllListeners();
            upgradeButton3.onClick.AddListener(() => SelectUpgrade(3));
        }

        if (showDetailedLogs)
        {
            Debug.Log("Button listeners set up!");
        }
    }

    void OnDisable()
    {
        // Called when leaving upgrade room
        ReenablePlayerControls();

        // Clear button listeners to prevent memory leaks
        if (upgradeButton1 != null)
        {
            upgradeButton1.onClick.RemoveAllListeners();
        }
        if (upgradeButton2 != null)
        {
            upgradeButton2.onClick.RemoveAllListeners();
        }
        if (upgradeButton3 != null)
        {
            upgradeButton3.onClick.RemoveAllListeners();
        }
    }

    void InitializeUpgradePool()
    {
        // Add all upgrade types to the pool
        availableUpgrades.Clear();
        availableUpgrades.Add(UpgradeType.MoveSpeed);
        availableUpgrades.Add(UpgradeType.MaxSpeed);
        availableUpgrades.Add(UpgradeType.Acceleration);
        availableUpgrades.Add(UpgradeType.SlideBoost);
        availableUpgrades.Add(UpgradeType.GroundDrag);
        availableUpgrades.Add(UpgradeType.AirDrag);
        availableUpgrades.Add(UpgradeType.JumpForce);
        availableUpgrades.Add(UpgradeType.FireRate);
    }

    void PrepareUpgradeRoom()
    {
        if (showDebugInfo)
        {
            Debug.Log("=== UPGRADE ROOM ENTERED ===");
        }

        // CRITICAL: Reset selection state
        hasSelectedUpgrade = false;

        // Disable pausing
        if (pauseManager != null)
        {
            pauseManager.SetCanPause(false);

            if (showDebugInfo)
            {
                Debug.Log("Pausing DISABLED in upgrade room");
            }
        }
        else
        {
            Debug.LogWarning("PauseManager reference not set! Cannot disable pausing in upgrade room. Assign it in UpgradeManager Inspector.");
        }

        // Disable player controls
        if (movementScript != null)
        {
            movementScript.enabled = false;
        }

        if (shootingScript != null)
        {
            shootingScript.enabled = false;
        }

        // Disable camera movement AND unlock cursor
        if (cameraControlScript != null)
        {
            cameraControlScript.enabled = false;

            if (showDebugInfo)
            {
                Debug.Log($"Disabled camera control: {cameraControlScript.GetType().Name}");
            }
        }

        // Unlock and show cursor for UI interaction
        Cursor.lockState = CursorLockMode.None;
        Cursor.visible = true;

        // Reset selection state
        hasSelectedUpgrade = false;

        if (showDebugInfo)
        {
            Debug.Log($"hasSelectedUpgrade reset to FALSE - buttons should work now!");
        }

        // Show upgrade buttons
        if (upgradeButton1 != null) upgradeButton1.gameObject.SetActive(true);
        if (upgradeButton2 != null) upgradeButton2.gameObject.SetActive(true);
        if (upgradeButton3 != null) upgradeButton3.gameObject.SetActive(true);

        // Show Texts
        if (upgradeText1 != null) upgradeText1.gameObject.SetActive(true);
        if (upgradeText2 != null) upgradeText2.gameObject.SetActive(true);
        if (upgradeText3 != null) upgradeText3.gameObject.SetActive(true);

        if (showDebugInfo)
        {
            Debug.Log("Upgrade buttons set to ACTIVE");
        };

        // Hide continue button
        if (continueButton != null)
        {
            continueButton.SetActive(false);
        }

        // Randomize upgrades for the 3 buttons (even during prewarm)
        RandomizeUpgrades();
    }

    void ReenablePlayerControls()
    {
        if (showDebugInfo)
        {
            Debug.Log("Re-enabling player controls...");
        }

        // Re-enable pausing
        if (pauseManager != null)
        {
            pauseManager.SetCanPause(true);
        }

        // Re-enable player controls
        if (movementScript != null)
        {
            movementScript.enabled = true;
        }

        if (shootingScript != null)
        {
            shootingScript.enabled = true;
        }

        // Re-enable camera
        if (cameraControlScript != null)
        {
            cameraControlScript.enabled = true;

            if (showDebugInfo)
            {
                Debug.Log($"Re-enabled camera control: {cameraControlScript.GetType().Name}");
            }
        }

        // Lock cursor back for gameplay
        Cursor.lockState = CursorLockMode.Locked;
        Cursor.visible = false;
    }

    void RandomizeUpgrades()
    {
        // Make sure we have at least 3 upgrades available
        if (availableUpgrades.Count < 3)
        {
            Debug.LogError("UpgradeManager: Need at least 3 upgrade types! Only have " + availableUpgrades.Count);
            return;
        }

        // Shuffle and pick 3 unique upgrades
        List<UpgradeType> shuffled = new List<UpgradeType>(availableUpgrades);

        // Fisher-Yates shuffle
        for (int i = shuffled.Count - 1; i > 0; i--)
        {
            int randomIndex = Random.Range(0, i + 1);
            UpgradeType temp = shuffled[i];
            shuffled[i] = shuffled[randomIndex];
            shuffled[randomIndex] = temp;
        }

        // Assign first 3 shuffled upgrades to buttons
        selectedUpgrade1 = shuffled[0];
        selectedUpgrade2 = shuffled[1];
        selectedUpgrade3 = shuffled[2];

        // Update button sprites
        UpdateButtonSprite(upgradeButton1, selectedUpgrade1);
        UpdateButtonSprite(upgradeButton2, selectedUpgrade2);
        UpdateButtonSprite(upgradeButton3, selectedUpgrade3);

        // Update text labels
        UpdateButtonText(upgradeText1, selectedUpgrade1);
        UpdateButtonText(upgradeText2, selectedUpgrade2);
        UpdateButtonText(upgradeText3, selectedUpgrade3);

        // Warn once if all sprites are the same (only check after all buttons updated)
        if (showDebugInfo && moveSpeedSprite != null && moveSpeedSprite == maxSpeedSprite && maxSpeedSprite == accelerationSprite)
        {
            Debug.LogWarning("WARNING: All upgrade sprites appear to be the same! Assign unique sprites for each upgrade type in UpgradeManager Inspector.");
        }

        if (showDebugInfo)
        {
            Debug.Log($"Upgrades randomized: {selectedUpgrade1}, {selectedUpgrade2}, {selectedUpgrade3}");
        }
    }

    void UpdateButtonSprite(Button button, UpgradeType upgradeType)
    {
        if (button == null)
        {
            if (showDebugInfo) Debug.LogWarning("UpdateButtonSprite: Button is null!");
            return;
        }

        Image buttonImage = button.GetComponent<Image>();
        if (buttonImage == null)
        {
            if (showDebugInfo) Debug.LogWarning($"UpdateButtonSprite: No Image component on button {button.name}!");
            return;
        }

        // Assign sprite based on upgrade type
        Sprite spriteToAssign = null;

        switch (upgradeType)
        {
            case UpgradeType.MoveSpeed:
                spriteToAssign = moveSpeedSprite;
                break;
            case UpgradeType.MaxSpeed:
                spriteToAssign = maxSpeedSprite;
                break;
            case UpgradeType.Acceleration:
                spriteToAssign = accelerationSprite;
                break;
            case UpgradeType.SlideBoost:
                spriteToAssign = slideBoostSprite;
                break;
            case UpgradeType.GroundDrag:
                spriteToAssign = groundDragSprite;
                break;
            case UpgradeType.AirDrag:
                spriteToAssign = airDragSprite;
                break;
            case UpgradeType.JumpForce:
                spriteToAssign = jumpForceSprite;
                break;
            case UpgradeType.FireRate:
                spriteToAssign = fireRateSprite;
                break;
        }

        if (spriteToAssign != null)
        {
            buttonImage.sprite = spriteToAssign;
            if (showDetailedLogs) // Changed from showDebugInfo
            {
                Debug.Log($"Button {button.name}: Assigned {upgradeType} sprite (Sprite name: '{spriteToAssign.name}')");
            }
        }
        else
        {
            if (showDebugInfo) Debug.LogWarning($"No sprite assigned for {upgradeType}! Assign sprites in UpgradeManager Inspector.");
        }
    }

    void SelectUpgrade(int buttonNumber)
    {
        // Prevent multiple selections
        if (hasSelectedUpgrade)
        {
            if (showDebugInfo)
            {
                Debug.LogWarning($"Already selected an upgrade! Ignoring button {buttonNumber}");
            }
            return;
        }

        hasSelectedUpgrade = true;

        if (showDebugInfo)
        {
            Debug.Log($"=== SELECT UPGRADE CALLED: Button {buttonNumber} ===");
        }

        // Determine which upgrade was selected
        UpgradeType selectedUpgrade = UpgradeType.MoveSpeed; // Default

        switch (buttonNumber)
        {
            case 1:
                selectedUpgrade = selectedUpgrade1;
                break;
            case 2:
                selectedUpgrade = selectedUpgrade2;
                break;
            case 3:
                selectedUpgrade = selectedUpgrade3;
                break;
        }

        if (showDebugInfo)
        {
            Debug.Log($"Player selected: {selectedUpgrade} from Button {buttonNumber}");
            Debug.Log($"Button assignments: 1={selectedUpgrade1}, 2={selectedUpgrade2}, 3={selectedUpgrade3}");
        }

        // Apply the upgrade
        ApplyUpgrade(selectedUpgrade);

        // Play particle effect (optional)
        if (upgradeParticleEffect != null && player != null)
        {
            Instantiate(upgradeParticleEffect, player.transform.position, Quaternion.identity);
        }

        // Hide upgrade buttons and show continue button
        if (upgradeButton1 != null) upgradeButton1.gameObject.SetActive(false);
        if (upgradeButton2 != null) upgradeButton2.gameObject.SetActive(false);
        if (upgradeButton3 != null) upgradeButton3.gameObject.SetActive(false);
        if (upgradeText1 != null) upgradeText1.gameObject.SetActive(false);
        if (upgradeText2 != null) upgradeText2.gameObject.SetActive(false);
        if (upgradeText3 != null) upgradeText3.gameObject.SetActive(false);

        if (continueButton != null)
        {
            continueButton.SetActive(true);
        }

        if (showDebugInfo)
        {
            Debug.Log("=== UPGRADE SELECTION COMPLETE ===");
        }
    }

    void UpdateButtonText(TMPro.TextMeshProUGUI textLabel, UpgradeType upgradeType)
    {
        if (textLabel == null) return; // Text labels are optional

        string upgradeName = "";
        string upgradeDesc = "";

        switch (upgradeType)
        {
            case UpgradeType.MoveSpeed:
                upgradeName = "Movement Speed";
                upgradeDesc = moveSpeedLevel < moveSpeedTiers.Length ? $" > {moveSpeedTiers[moveSpeedLevel]}" : "(MAX)";
                break;
            case UpgradeType.MaxSpeed:
                upgradeName = "Max Speed";
                upgradeDesc = maxSpeedLevel < maxSpeedTiers.Length ? $" > {maxSpeedTiers[maxSpeedLevel]}" : "(MAX)";
                break;
            case UpgradeType.Acceleration:
                upgradeName = "Acceleration";
                upgradeDesc = accelerationLevel < accelerationTiers.Length ? $" > {accelerationTiers[accelerationLevel]}" : "(MAX)";
                break;
            case UpgradeType.SlideBoost:
                upgradeName = "Slide Boost";
                upgradeDesc = slideBoostLevel < slideBoostTiers.Length ? $" > {slideBoostTiers[slideBoostLevel]}" : "(MAX)";
                break;
            case UpgradeType.GroundDrag:
                upgradeName = "Ground Friction";
                upgradeDesc = groundDragLevel < groundDragTiers.Length ? $" > {groundDragTiers[groundDragLevel]}" : "(MAX)";
                break;
            case UpgradeType.AirDrag:
                upgradeName = "Air Control";
                upgradeDesc = airDragLevel < airDragTiers.Length ? $" > {airDragTiers[airDragLevel]}" : "(MAX)";
                break;
            case UpgradeType.JumpForce:
                upgradeName = "Jump Height";
                upgradeDesc = jumpForceLevel < jumpForceTiers.Length ? $" > {jumpForceTiers[jumpForceLevel]}" : "(MAX)";
                break;
            case UpgradeType.FireRate:
                upgradeName = "Fire Rate";
                upgradeDesc = fireRateLevel < fireRateTiers.Length ? $" > {fireRateTiers[fireRateLevel]}s" : "(MAX)";
                break;
        }

        textLabel.text = $"{upgradeName}\n{upgradeDesc}";
    }

    void ApplyUpgrade(UpgradeType upgradeType)
    {
        if (movementScript == null || shootingScript == null) return;

        switch (upgradeType)
        {
            case UpgradeType.MoveSpeed:
                if (moveSpeedLevel < moveSpeedTiers.Length)
                {
                    movementScript.moveSpeed = moveSpeedTiers[moveSpeedLevel];
                    if (showDebugInfo) Debug.Log($"Applied: Move Speed SET to {moveSpeedTiers[moveSpeedLevel]} (Level {moveSpeedLevel + 1})");
                    moveSpeedLevel++;
                }
                else
                {
                    if (showDebugInfo) Debug.Log("Move Speed already at max level!");
                }
                break;

            case UpgradeType.MaxSpeed:
                if (maxSpeedLevel < maxSpeedTiers.Length)
                {
                    movementScript.maxSpeed = maxSpeedTiers[maxSpeedLevel];
                    if (showDebugInfo) Debug.Log($"Applied: Max Speed SET to {maxSpeedTiers[maxSpeedLevel]} (Level {maxSpeedLevel + 1})");
                    maxSpeedLevel++;
                }
                break;

            case UpgradeType.Acceleration:
                if (accelerationLevel < accelerationTiers.Length)
                {
                    movementScript.acceleration = accelerationTiers[accelerationLevel];
                    if (showDebugInfo) Debug.Log($"Applied: Acceleration SET to {accelerationTiers[accelerationLevel]} (Level {accelerationLevel + 1})");
                    accelerationLevel++;
                }
                break;

            case UpgradeType.SlideBoost:
                if (slideBoostLevel < slideBoostTiers.Length)
                {
                    movementScript.slideBoost = slideBoostTiers[slideBoostLevel];
                    if (showDebugInfo) Debug.Log($"Applied: Slide Boost SET to {slideBoostTiers[slideBoostLevel]} (Level {slideBoostLevel + 1})");
                    slideBoostLevel++;
                }
                break;

            case UpgradeType.GroundDrag:
                if (groundDragLevel < groundDragTiers.Length)
                {
                    movementScript.groundDrag = groundDragTiers[groundDragLevel];
                    if (showDebugInfo) Debug.Log($"Applied: Ground Drag SET to {groundDragTiers[groundDragLevel]} (Level {groundDragLevel + 1})");
                    groundDragLevel++;
                }
                break;

            case UpgradeType.AirDrag:
                if (airDragLevel < airDragTiers.Length)
                {
                    movementScript.airDrag = airDragTiers[airDragLevel];
                    if (showDebugInfo) Debug.Log($"Applied: Air Drag SET to {airDragTiers[airDragLevel]} (Level {airDragLevel + 1})");
                    airDragLevel++;
                }
                break;

            case UpgradeType.JumpForce:
                if (jumpForceLevel < jumpForceTiers.Length)
                {
                    movementScript.jumpForce = jumpForceTiers[jumpForceLevel];
                    if (showDebugInfo) Debug.Log($"Applied: Jump Force SET to {jumpForceTiers[jumpForceLevel]} (Level {jumpForceLevel + 1})");
                    jumpForceLevel++;
                }
                break;

            case UpgradeType.FireRate:
                if (fireRateLevel < fireRateTiers.Length)
                {
                    shootingScript.fireRate = fireRateTiers[fireRateLevel];
                    if (showDebugInfo) Debug.Log($"Applied: Fire Rate SET to {fireRateTiers[fireRateLevel]} (Level {fireRateLevel + 1}) - FASTER SHOOTING!");
                    fireRateLevel++;
                }
                break;
        }
    }

    // Call this when player dies or starts a new run
    public void ResetAllUpgrades()
    {
        // Reset all upgrade levels
        moveSpeedLevel = 0;
        maxSpeedLevel = 0;
        accelerationLevel = 0;
        slideBoostLevel = 0;
        groundDragLevel = 0;
        airDragLevel = 0;
        jumpForceLevel = 0;
        fireRateLevel = 0;

        if (showDebugInfo)
        {
            Debug.Log("All upgrade levels reset to 0!");
        }
    }
}
