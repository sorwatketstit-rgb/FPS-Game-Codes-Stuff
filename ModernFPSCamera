using UnityEngine;

public class ModernFPSCamera : MonoBehaviour
{
    [Header("References")]
    [Tooltip("The player's transform (the one with Rigidbody)")]
    public Transform player;

    [Tooltip("Camera holder - create empty GameObject as child of player")]
    public Transform cameraHolder;

    [Header("Mouse Settings")]
    [Range(1f, 1000f)]
    public float mouseSensitivity = 400f;

    [Tooltip("Invert Y-axis (up/down)")]
    public bool invertY = false;

    [Header("Camera Limits")]
    [Range(60f, 90f)]
    public float maxLookAngle = 90f;

    [Header("Position Settings")]
    [Tooltip("Camera offset from player center (height mostly)")]
    public Vector3 cameraOffset = new Vector3(0f, 0.6f, 0f);

    [Header("Camera Bobbing")]
    public float bobFrequency = 8f;
    public float bobHorizontalAmplitude = 0.05f;
    public float bobVerticalAmplitude = 0.05f;

    private float xRotation = 0f;
    private float yRotation = 0f;

    private float bobTimer = 0f;
    private Vector3 bobOffset = Vector3.zero;

    private Rigidbody playerRb;

    void Start()
    {
        Cursor.lockState = CursorLockMode.Locked;
        Cursor.visible = false;

        if (player == null)
        {
            Debug.LogError("Player reference not assigned!");
            enabled = false;
            return;
        }

        if (cameraHolder == null)
        {
            cameraHolder = transform;
        }

        playerRb = player.GetComponent<Rigidbody>();

        yRotation = player.eulerAngles.y;

        Debug.Log("FPS Camera Ready! Press ESC to unlock cursor.");
    }

    void Update()
    {
        if (Input.GetKeyDown(KeyCode.Escape))
        {
            ToggleCursor();
        }

        if (Cursor.lockState == CursorLockMode.Locked)
        {
            HandleMouseLook();
        }
    }

    void LateUpdate()
    {
        UpdateCameraPosition();
    }

    void HandleMouseLook()
    {
        float mouseX = Input.GetAxisRaw("Mouse X") * mouseSensitivity * Time.deltaTime;
        float mouseY = Input.GetAxisRaw("Mouse Y") * mouseSensitivity * Time.deltaTime;

        if (invertY) mouseY = -mouseY;

        xRotation -= mouseY;
        xRotation = Mathf.Clamp(xRotation, -maxLookAngle, maxLookAngle);

        yRotation += mouseX;

        cameraHolder.localRotation = Quaternion.Euler(xRotation, 0f, 0f);
        player.rotation = Quaternion.Euler(0f, yRotation, 0f);
    }

    void UpdateCameraPosition()
    {
        HandleCameraBobbing();

        cameraHolder.position = player.position + cameraOffset + bobOffset;
    }

    void HandleCameraBobbing()
    {
        if (playerRb == null)
        {
            bobOffset = Vector3.zero;
            return;
        }

        Vector3 horizontalVelocity = new Vector3(playerRb.linearVelocity.x, 0f, playerRb.linearVelocity.z);
        float speed = horizontalVelocity.magnitude;

        if (speed > 0.1f)
        {
            bobTimer += Time.deltaTime * bobFrequency;

            float horizontalBob = Mathf.Sin(bobTimer) * bobHorizontalAmplitude;
            float verticalBob = Mathf.Abs(Mathf.Cos(bobTimer)) * bobVerticalAmplitude;

            bobOffset = new Vector3(horizontalBob, verticalBob, 0f);
        }
        else
        {
            bobTimer = 0f;
            bobOffset = Vector3.Lerp(bobOffset, Vector3.zero, Time.deltaTime * 10f);
        }
    }

    void ToggleCursor()
    {
        Cursor.lockState = Cursor.lockState == CursorLockMode.Locked ?
            CursorLockMode.None : CursorLockMode.Locked;
        Cursor.visible = !Cursor.visible;
    }

    public void SetSensitivity(float sensitivity)
    {
        mouseSensitivity = Mathf.Clamp(sensitivity, 1f, 1000f);
    }
}
