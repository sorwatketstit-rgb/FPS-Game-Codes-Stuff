using UnityEngine;

public class ModernFPSCamera : MonoBehaviour
{
    [Header("References")]
    [Tooltip("The player's transform (the one with Rigidbody)")]
    public Transform player;

    [Tooltip("Camera holder - create empty GameObject as child of player")]
    public Transform cameraHolder;

    [Header("Mouse Settings")]
    [Range(1f, 1000f)]
    public float mouseSensitivity = 400f;

    [Tooltip("Invert Y-axis (up/down)")]
    public bool invertY = false;

    [Header("Camera Limits")]
    [Range(60f, 90f)]
    public float maxLookAngle = 90f;

    [Header("Position Settings")]
    [Tooltip("Camera offset from player center (height mostly)")]
    public Vector3 cameraOffset = new Vector3(0f, 0.6f, 0f);

    private float xRotation = 0f;
    private float yRotation = 0f;

    void Start()
    {
        // Lock cursor
        Cursor.lockState = CursorLockMode.Locked;
        Cursor.visible = false;

        // Validation
        if (player == null)
        {
            Debug.LogError("Player reference not assigned!");
            enabled = false;
            return;
        }

        // Initialize camera position
        if (cameraHolder == null)
        {
            cameraHolder = transform;
        }

        // Set initial rotations
        yRotation = player.eulerAngles.y;

        Debug.Log("FPS Camera Ready! Press ESC to unlock cursor.");
    }

    void Update()
    {
        // Cursor toggle
        if (Input.GetKeyDown(KeyCode.Escape))
        {
            ToggleCursor();
        }

        if (Cursor.lockState == CursorLockMode.Locked)
        {
            HandleMouseLook();
        }
    }

    void LateUpdate()
    {
        // Update camera position AFTER all physics (prevents jitter)
        UpdateCameraPosition();
    }

    void HandleMouseLook()
    {
        // Get raw mouse delta (works with both old and new input system)
        float mouseX = Input.GetAxisRaw("Mouse X") * mouseSensitivity * Time.deltaTime;
        float mouseY = Input.GetAxisRaw("Mouse Y") * mouseSensitivity * Time.deltaTime;

        if (invertY) mouseY = -mouseY;

        // Vertical rotation (camera only - looking up/down)
        xRotation -= mouseY;
        xRotation = Mathf.Clamp(xRotation, -maxLookAngle, maxLookAngle);

        // Horizontal rotation (player body - looking left/right)
        yRotation += mouseX;

        // Apply rotations
        cameraHolder.localRotation = Quaternion.Euler(xRotation, 0f, 0f);
        player.rotation = Quaternion.Euler(0f, yRotation, 0f);
    }

    void UpdateCameraPosition()
    {
        // Keep camera at player position + offset
        // LateUpdate ensures this happens AFTER physics
        cameraHolder.position = player.position + cameraOffset;
    }

    void ToggleCursor()
    {
        Cursor.lockState = Cursor.lockState == CursorLockMode.Locked ?
            CursorLockMode.None : CursorLockMode.Locked;
        Cursor.visible = !Cursor.visible;
    }

    public void SetSensitivity(float sensitivity)
    {
        mouseSensitivity = Mathf.Clamp(sensitivity, 1f, 1000f);
    }
}
