using UnityEngine;
using UnityEngine.UI;
using UnityEngine.Rendering;
using UnityEngine.Rendering.Universal;
using TMPro;

public class SettingsManager : MonoBehaviour
{
    [Header("Camera References")]
    [Tooltip("Player camera")]
    public Camera playerCamera;

    [Tooltip("Camera script (for sensitivity)")]
    public ModernFPSCamera cameraScript;

    [Header("Shooting Reference")]
    [Tooltip("Shooting script (for zoom FOV)")]
    public PlayerShooting shootingScript;

    [Header("Post Processing")]
    [Tooltip("Volume for post-processing effects")]
    public Volume postProcessVolume;

    [Header("UI Sliders")]
    [Tooltip("Slider for mouse sensitivity")]
    public Slider sensitivitySlider;

    [Tooltip("Slider for field of view")]
    public Slider fovSlider;

    [Tooltip("Slider for zoom FOV")]
    public Slider zoomFovSlider;

    [Header("UI Toggles")]
    [Tooltip("Toggle for post-processing effects")]
    public Toggle postProcessingToggle;

    [Header("UI Text (Optional)")]
    [Tooltip("Text to display current sensitivity value (TextMeshPro)")]
    public TextMeshProUGUI sensitivityValueText;

    [Tooltip("Text to display current FOV value (TextMeshPro)")]
    public TextMeshProUGUI fovValueText;

    [Tooltip("Text to display current zoom FOV value (TextMeshPro)")]
    public TextMeshProUGUI zoomFovValueText;

    [Header("Default Values")]
    public float defaultSensitivity = 400f;
    public float defaultFOV = 60f;
    public float defaultZoomFOV = 30f;
    public bool defaultPostProcessing = true;

    [Header("Debug")]
    public bool showDebugInfo = true;

    void Start()
    {
        // Configure slider ranges to prevent issues
        ConfigureSliderRanges();

        // ONLY set up listeners - don't touch camera/player at all
        SetupListeners();

        if (showDebugInfo)
        {
            Debug.Log("SettingsManager ready (passive mode)");
        }
    }

    void ConfigureSliderRanges()
    {
        // Set sensitivity slider range (1 to 1000)
        if (sensitivitySlider != null)
        {
            sensitivitySlider.minValue = 1f;
            sensitivitySlider.maxValue = 1000f;
            sensitivitySlider.wholeNumbers = true;
        }

        // Set FOV slider range (30 to 120) - CRITICAL: Don't let it go to 1!
        if (fovSlider != null)
        {
            fovSlider.minValue = 30f;
            fovSlider.maxValue = 120f;
            fovSlider.wholeNumbers = true;
        }

        // Set Zoom FOV slider range (INVERTED: 10 to 60, but slider shows opposite)
        // Higher slider value = MORE zoom (LOWER FOV)
        if (zoomFovSlider != null)
        {
            zoomFovSlider.minValue = 10f;  // Less zoom
            zoomFovSlider.maxValue = 60f;  // More zoom
            zoomFovSlider.wholeNumbers = true;
        }

        if (showDebugInfo)
        {
            Debug.Log("Slider ranges configured: Sensitivity(1-1000), FOV(30-120), ZoomFOV(10-60 inverted)");
        }
    }

    void SetupListeners()
    {
        if (sensitivitySlider != null)
        {
            sensitivitySlider.onValueChanged.AddListener(OnSensitivityChanged);
        }

        if (fovSlider != null)
        {
            fovSlider.onValueChanged.AddListener(OnFOVChanged);
        }

        if (zoomFovSlider != null)
        {
            zoomFovSlider.onValueChanged.AddListener(OnZoomFOVChanged);
        }

        if (postProcessingToggle != null)
        {
            postProcessingToggle.onValueChanged.AddListener(OnPostProcessingToggled);
        }
    }

    /// <summary>
    /// Call this PUBLIC method when settings panel opens to refresh UI
    /// </summary>
    public void RefreshSettingsUI()
    {
        if (showDebugInfo)
        {
            Debug.Log("Refreshing settings UI...");
        }

        // Find player references NOW (not on Start)
        FindPlayerReferences();

        // Update UI sliders to match CURRENT game values
        UpdateUI();
    }

    /// <summary>
    /// Reapply FOV setting (call when resuming game to prevent reset)
    /// </summary>
    public void RefreshCameraFOV()
    {
        // DON'T change FOV when resuming game
        // The camera FOV is already correct - leave it alone!
        // This method is kept for compatibility but does nothing

        if (showDebugInfo && playerCamera != null)
        {
            Debug.Log($"Camera FOV left unchanged at: {playerCamera.fieldOfView}");
        }
    }

    void FindPlayerReferences()
    {
        // Only find if not already assigned
        if (playerCamera == null)
        {
            playerCamera = Camera.main;
        }

        if (cameraScript == null && playerCamera != null)
        {
            cameraScript = playerCamera.GetComponent<ModernFPSCamera>();
        }

        if (shootingScript == null)
        {
            shootingScript = FindFirstObjectByType<PlayerShooting>();
        }

        if (postProcessVolume == null)
        {
            postProcessVolume = FindFirstObjectByType<Volume>();
        }
    }

    void SaveSettings()
    {
        // Save current values to PlayerPrefs
        if (cameraScript != null)
        {
            PlayerPrefs.SetFloat("Sensitivity", cameraScript.mouseSensitivity);
        }

        if (playerCamera != null)
        {
            PlayerPrefs.SetFloat("FOV", playerCamera.fieldOfView);
        }

        if (shootingScript != null)
        {
            PlayerPrefs.SetFloat("ZoomFOV", shootingScript.zoomFOV);
        }

        if (postProcessVolume != null)
        {
            PlayerPrefs.SetInt("PostProcessing", postProcessVolume.enabled ? 1 : 0);
        }

        PlayerPrefs.Save();

        if (showDebugInfo)
        {
            Debug.Log("Settings saved!");
        }
    }

    // ========== SENSITIVITY ==========

    void OnSensitivityChanged(float value)
    {
        SetSensitivity(value);

        // Delayed save to prevent white flash
        CancelInvoke("SaveSettings");
        Invoke("SaveSettings", 0.5f);
    }

    void SetSensitivity(float value)
    {
        // Clamp sensitivity to reasonable range
        value = Mathf.Clamp(value, 1f, 1000f);

        if (cameraScript != null)
        {
            cameraScript.mouseSensitivity = value;
        }

        UpdateSensitivityText();
    }

    // ========== FIELD OF VIEW ==========

    void OnFOVChanged(float value)
    {
        SetFOV(value);

        // Delayed save to prevent white flash
        CancelInvoke("SaveSettings");
        Invoke("SaveSettings", 0.5f);
    }

    void SetFOV(float value)
    {
        // CRITICAL: Clamp FOV to safe range to prevent white screen
        value = Mathf.Clamp(value, 30f, 120f);

        if (playerCamera != null)
        {
            playerCamera.fieldOfView = value;
        }

        UpdateFOVText();

        if (showDebugInfo && value != playerCamera.fieldOfView)
        {
            Debug.LogWarning($"FOV clamped from {playerCamera.fieldOfView} to {value} for safety");
        }
    }

    // ========== ZOOM FOV ==========

    void OnZoomFOVChanged(float value)
    {
        // INVERT: Higher slider value = MORE zoom (LOWER FOV)
        // Map slider (10-60) to FOV (60-10)
        float invertedValue = 70f - value; // 70 - 10 = 60, 70 - 60 = 10
        SetZoomFOV(invertedValue);

        // Delayed save to prevent white flash
        CancelInvoke("SaveSettings");
        Invoke("SaveSettings", 0.5f);
    }

    void SetZoomFOV(float value)
    {
        // Clamp zoom FOV to reasonable range
        value = Mathf.Clamp(value, 10f, 60f);

        if (shootingScript != null)
        {
            shootingScript.zoomFOV = value;
        }

        UpdateZoomFOVText();
    }

    // ========== POST PROCESSING ==========

    void OnPostProcessingToggled(bool isOn)
    {
        SetPostProcessing(isOn);
        SaveSettings();
    }

    void SetPostProcessing(bool enabled)
    {
        if (postProcessVolume != null)
        {
            postProcessVolume.enabled = enabled;
        }
    }

    // ========== UI UPDATE ==========

    void UpdateUI()
    {
        // Temporarily remove listeners to prevent triggering callbacks
        RemoveListeners();

        // Update slider values to match current settings
        if (sensitivitySlider != null && cameraScript != null)
        {
            sensitivitySlider.value = cameraScript.mouseSensitivity;
        }

        if (fovSlider != null && playerCamera != null)
        {
            fovSlider.value = playerCamera.fieldOfView;
        }

        // INVERTED ZOOM: If game has FOV 30 (high zoom), slider should show 40 (70-30=40)
        if (zoomFovSlider != null && shootingScript != null)
        {
            zoomFovSlider.value = 70f - shootingScript.zoomFOV;
        }

        if (postProcessingToggle != null && postProcessVolume != null)
        {
            postProcessingToggle.isOn = postProcessVolume.enabled;
        }

        // Manually update text displays with current values
        UpdateSensitivityText();
        UpdateFOVText();
        UpdateZoomFOVText();

        // Re-add listeners
        SetupListeners();
    }

    void RemoveListeners()
    {
        if (sensitivitySlider != null)
        {
            sensitivitySlider.onValueChanged.RemoveAllListeners();
        }

        if (fovSlider != null)
        {
            fovSlider.onValueChanged.RemoveAllListeners();
        }

        if (zoomFovSlider != null)
        {
            zoomFovSlider.onValueChanged.RemoveAllListeners();
        }

        if (postProcessingToggle != null)
        {
            postProcessingToggle.onValueChanged.RemoveAllListeners();
        }
    }

    void UpdateSensitivityText()
    {
        if (sensitivityValueText != null && cameraScript != null)
        {
            sensitivityValueText.text = cameraScript.mouseSensitivity.ToString("F0");
        }
        else if (sensitivityValueText != null && sensitivitySlider != null)
        {
            // Fallback to slider value if camera not found
            sensitivityValueText.text = sensitivitySlider.value.ToString("F0");
        }
    }

    void UpdateFOVText()
    {
        if (fovValueText != null && playerCamera != null)
        {
            fovValueText.text = playerCamera.fieldOfView.ToString("F0");
        }
        else if (fovValueText != null && fovSlider != null)
        {
            // Fallback to slider value if camera not found
            fovValueText.text = fovSlider.value.ToString("F0");
        }
    }

    void UpdateZoomFOVText()
    {
        if (zoomFovValueText != null && shootingScript != null)
        {
            zoomFovValueText.text = shootingScript.zoomFOV.ToString("F0");
        }
        else if (zoomFovValueText != null && zoomFovSlider != null)
        {
            // Fallback to slider value if shooting script not found
            zoomFovValueText.text = zoomFovSlider.value.ToString("F0");
        }
    }

    // ========== RESET TO DEFAULTS ==========

    public void ResetToDefaults()
    {
        SetSensitivity(defaultSensitivity);
        SetFOV(defaultFOV);
        SetZoomFOV(defaultZoomFOV);
        SetPostProcessing(defaultPostProcessing);

        UpdateUI();
        SaveSettings();

        if (showDebugInfo)
        {
            Debug.Log("Settings reset to defaults!");
        }
    }
}
